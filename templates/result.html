{% extends "layout.html" %}
{% block content %}
<!--危険度に応じて背景色を変更-->
{% if summary['malicious'] >= 1 %}
<style>
    body {
        background-color: #940000;
    }
</style>
{% elif summary['suspicious'] >= 2 %}
<style>
    body {
        color: #000000;
        background-color: #eeea00;
    }
</style>
{% endif %}
<main class="result">
    <!--共通部分-->
    <h1>スキャン結果</h1>
    {% if summary['malicious'] >= 1 %}
    <p>危険であると考えられます</p>
    {% elif summary['suspicious'] >= 2 %}
    <p>危険な可能性があります</p>
    {% else %}
    <p>安全であると考えられます</p>
    {% endif %}
    <!--グラフ-->
    <div style="width: 30%">
        <canvas id="myPieChart"></canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0 "></script>
    <script>
        var summary = JSON.parse('{{ summary|tojson|safe }}');
        const ctx = document.getElementById("myPieChart").getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'pie', 
            data: {
                labels: ["非常に危険", "やや危険", "安全", "判定不可", "失敗", "サポートされていない","タイムアウト"],
                datasets: [{
                    label: '分析結果',
                    backgroundColor: ["#FF8888","#FFFF88","#88FF88","#8888FF", "#FFBB88","#BB88FF","#CCCCCC",],
                    borderColor: '#FFF',
                    borderWidth: 2,
                    data: [summary.malicious, summary.suspicious, summary.harmless, summary.undetected, summary.failure, summary.type_unsupported, summary.timeout+summary.confirmed_timeout]
                }]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                plugins: {
                    legend: {
                            position: 'top',
                            labels: {
                                color: "#FFFFFF",
                            }
                        },
                    datalabels: { 
                        display: function(context) {
                            var value = context.dataset.data[context.dataIndex];
                            return value > 0;
                        },
                        formatter: function(value, context) { 
                            return context.chart.data.labels[context.dataIndex];
                        },
                        color:"#000", 
                        font: {
                            weight: "bold", 
                            size: 24, 
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const dataset = tooltipItem.dataset;
                                const total = dataset.data.reduce((acc, value) => acc + value, 0);
                                const value = dataset.data[tooltipItem.dataIndex];
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${dataset.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    </script>
    <br>
    <!--URL-->
    {% if scan == "url" %}
    <p>URL: {{summary['url']}}</p>
    <p>最後に分析された日: {{summary['date']}}</p>
    <br>
    <p>悪意があるURLであると判定した数: {{summary['malicious']}}</p>
    <p>悪意がある可能性のあるURLであると判定した数: {{summary['suspicious']}}</p>
    <p>安全なURLであると判定した数: {{summary['harmless']}}</p>
    <p>判定できなかった数: {{summary['undetected']}}</p>
    <p>タイムアウトした数: {{summary['timeout']}}</p>
    <p><img src="/static/img/tmp.jpg"></p>
    {% endif %}
    <!--ファイル-->
    {% if scan == "file" %}
    <p>最後に分析された日: {{summary['date']}}</p>
    <p>ファイルサイズ: {{summary['size']}} バイト</p>
    <br>
    <p>悪意があるファイルであると判定した数: {{summary['malicious']}}</p>
    <p>悪意がある可能性のあるファイルであると判定した数: {{summary['suspicious']}}</p>
    <p>安全なファイルであると判定した数: {{summary['harmless']}}</p>
    <p>判定できなかった数: {{summary['undetected']}}</p>
    <p>失敗した数: {{summary['failure']}}</p>
    <p>サポートされていない数: {{summary['type_unsupported']}}</p>
    <p>タイムアウトした数: {{summary['timeout']+summary['confirmed_timeout']}}</p>
    {% endif %}
    <!--ファイルハッシュ-->
    {% if scan == "hash" %}
    <p>最後に分析された日: {{summary['date']}}</p>
    <p>ファイル名: {{summary['name']}}</p>
    <p>ファイルサイズ: {{summary['size']}} バイト</p>
    <br>
    <p>悪意があるファイルであると判定した数: {{summary['malicious']}}</p>
    <p>悪意がある可能性のあるファイルであると判定した数: {{summary['suspicious']}}</p>
    <p>安全なファイルであると判定した数: {{summary['harmless']}}</p>
    <p>判定できなかった数: {{summary['undetected']}}</p>
    <p>失敗した数: {{summary['failure']}}</p>
    <p>サポートされていない数: {{summary['type_unsupported']}}</p>
    <p>タイムアウトした数: {{summary['timeout']+summary['confirmed_timeout']}}</p>
    {% endif %}
    <!--IPアドレス-->
    {% if scan == "ip" %}
    <p>最後に分析された日: {{summary['date']}}</p>
    <br>
    <p>悪意があるIPアドレスであると判定した数: {{summary['malicious']}}</p>
    <p>悪意がある可能性のあるIPアドレスであると判定した数: {{summary['suspicious']}}</p>
    <p>安全なIPアドレスであると判定した数: {{summary['harmless']}}</p>
    <p>判定できなかった数: {{summary['undetected']}}</p>
    <p>タイムアウトした数: {{summary['timeout']}}</p>
    {% endif %}
    <!--ドメイン-->
    {% if scan == "domain" %}
    <p>最後に分析された日: {{summary['date']}}</p>
    <br>
    <p>悪意があるドメインであると判定した数: {{summary['malicious']}}</p>
    <p>悪意がある可能性のあるドメインであると判定した数: {{summary['suspicious']}}</p>
    <p>安全なドメインであると判定した数: {{summary['harmless']}}</p>
    <p>判定できなかった数: {{summary['undetected']}}</p>
    <p>タイムアウトした数: {{summary['timeout']}}</p>
    {% endif %}
</main>
{% endblock %}